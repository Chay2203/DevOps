name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DOCKER_IMAGE_NAME: image-editor

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Determine Image Tag
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="${GITHUB_SHA::7}"
          fi
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Check Deployment Conditions
        id: check
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    needs: [validate]
    if: needs.validate.outputs.should_deploy == 'true'
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Verify kubectl
        run: kubectl version --client

      - name: Update Image Tag
        run: |
          cd k8s
          IMAGE_TAG="${{ needs.validate.outputs.image_tag }}"
          sed -i '' "s|newName: .*image-editor|newName: ${{ secrets.DOCKERHUB_USERNAME }}/image-editor|g" kustomization.yaml
          sed -i '' "s|newTag: .*|newTag: ${IMAGE_TAG}|g" kustomization.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k k8s/
          kubectl rollout status deployment/image-editor -n image-editor --timeout=300s

      - name: Verify Deployment
        run: |
          kubectl get pods -n image-editor -o wide
          kubectl get svc -n image-editor

      - name: Health Check
        run: kubectl wait --for=condition=ready pod -l app=image-editor -n image-editor --timeout=120s

  rollback:
    name: Rollback Deployment
    runs-on: self-hosted
    if: failure() && needs.deploy.result == 'failure'
    needs: [deploy]
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Rollback to Previous Version
        run: |
          kubectl rollout undo deployment/image-editor -n image-editor
          kubectl rollout status deployment/image-editor -n image-editor --timeout=300s

      - name: Verify Rollback
        run: |
          kubectl get pods -n image-editor -o wide
          kubectl get deployment image-editor -n image-editor

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always()

    steps:
      - name: Deployment Status Summary
        run: |
          echo "=============================================="
          echo "         CD Pipeline Summary                  "
          echo "=============================================="
          echo ""
          echo "Validation:       ${{ needs.validate.result }}"
          echo "Deployment:       ${{ needs.deploy.result }}"
          echo "Image Tag:        ${{ needs.validate.outputs.image_tag }}"
          echo "=============================================="
          if [[ "${{ needs.deploy.result }}" == "failure" ]]; then
            exit 1
          fi
