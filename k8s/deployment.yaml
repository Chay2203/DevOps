# =============================================================================
# Deployment - Manages the Image Editor application pods
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: image-editor
  namespace: image-editor
  labels:
    app: image-editor
spec:
  replicas: 2
  selector:
    matchLabels:
      app: image-editor
  template:
    metadata:
      labels:
        app: image-editor
    spec:
      # Security: Run as non-root user
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
        - name: image-editor
          # Image will be replaced by CI/CD with actual DockerHub image
          # For local testing: image-editor:local with imagePullPolicy: Never
          image: IMAGE_PLACEHOLDER
          imagePullPolicy: IfNotPresent

          # Keep container running (CLI tool doesn't run as daemon)
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Image Editor container started"
              java -jar image-editor.jar --help
              echo "Container ready - keeping alive for job submissions"
              tail -f /dev/null

          # Resource limits for stability
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          # Security context for container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

          # Health check - verify container is alive
          livenessProbe:
            exec:
              command: ["pgrep", "-f", "tail"]
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5

          # Volume mounts for image processing
          volumeMounts:
            - name: workdir
              mountPath: /app/output

      volumes:
        - name: workdir
          emptyDir: {}

      # Ensure pods are spread across nodes
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: image-editor
